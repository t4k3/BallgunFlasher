<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ballgun Flasher</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
        }
        .warning {
            background: #ff6b3520;
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .warning a {
            color: #ff6b35;
        }
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .left-panel {
            flex: 0 0 350px;
        }
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .device-panels {
            display: flex;
            gap: 15px;
        }
        .device-panel {
            flex: 1;
            background: #252540;
            border-radius: 12px;
            padding: 20px;
        }
        .device-panel h2 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .device-panel.driver h2 {
            color: #00d4ff;
        }
        .device-panel.display h2 {
            color: #e91e63;
        }
        .guide-section {
            background: #252540;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .guide-section h2 {
            margin: 0 0 15px 0;
            color: #00d4ff;
            font-size: 1.1em;
        }
        .guide-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .step-number {
            width: 28px;
            height: 28px;
            background: #00d4ff;
            color: #1a1a2e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .step-number.display-step {
            background: #e91e63;
            color: white;
        }
        .step-content {
            flex: 1;
        }
        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .step-desc {
            font-size: 13px;
            color: #888;
        }
        button {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-connect {
            background: #444;
            color: white;
        }
        .btn-connect:hover:not(:disabled) {
            background: #555;
        }
        .btn-connect.connected {
            background: #00c853;
        }
        .btn-update {
            background: linear-gradient(135deg, #00d4ff, #00acc1);
            color: #1a1a2e;
            font-size: 16px;
            padding: 15px;
        }
        .btn-update.display-btn {
            background: linear-gradient(135deg, #e91e63, #f06292);
            color: white;
        }
        .btn-update:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #1a1a2e;
            border-radius: 6px;
            font-size: 13px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff5252;
        }
        .status-dot.connected {
            background: #00c853;
        }
        .console-section {
            background: #252540;
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .console-section h2 {
            margin: 0 0 10px 0;
            color: #888;
            font-size: 1em;
        }
        #console {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
            display: none;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-bar.driver {
            background: linear-gradient(90deg, #00d4ff, #84ffff);
        }
        .progress-bar.display {
            background: linear-gradient(90deg, #e91e63, #f06292);
        }
        .chip-info {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
        }
        @media (max-width: 1000px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel {
                flex: none;
            }
            .device-panels {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Ballgun Flasher</h1>
    <p class="subtitle">ESP32-C6 Firmware Update Tool</p>

    <div class="warning" id="browserWarning" style="display: none;">
        WebSerial not supported. Please use <a href="https://www.google.com/chrome/" target="_blank">Google Chrome</a> or Microsoft Edge.
    </div>

    <div class="main-container">
        <!-- LEFT: Guide -->
        <div class="left-panel">
            <div class="guide-section">
                <h2>Update Guide</h2>

                <img src="guide.jpg" alt="Ballgun ESP32 locations" class="guide-image">

                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Connect DRIVER USB</div>
                        <div class="step-desc">Plug USB cable to the ESP32 on top (motor head)</div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Update DRIVER</div>
                        <div class="step-desc">Click Connect, then Update DRIVER</div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number display-step">3</div>
                    <div class="step-content">
                        <div class="step-title">Connect DISPLAY USB</div>
                        <div class="step-desc">Disconnect DRIVER, plug USB to ESP32 at bottom (yellow box)</div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number display-step">4</div>
                    <div class="step-content">
                        <div class="step-title">Update DISPLAY</div>
                        <div class="step-desc">Click Connect, then Update DISPLAY</div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number display-step">5</div>
                    <div class="step-content">
                        <div class="step-title">Done!</div>
                        <div class="step-desc">Disconnect and restart the Ballgun</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Controls & Console -->
        <div class="right-panel">
            <div class="device-panels">
                <!-- DRIVER Panel -->
                <div class="device-panel driver">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        DRIVER (Roller)
                    </h2>

                    <div class="status">
                        <div class="status-dot" id="driverStatusDot"></div>
                        <span id="driverStatusText">Disconnected</span>
                    </div>

                    <button class="btn-connect" id="driverConnectBtn">
                        Connect DRIVER
                    </button>
                    <button class="btn-update" id="driverUpdateBtn" disabled>
                        Update DRIVER
                    </button>

                    <div class="progress" id="driverProgress">
                        <div class="progress-bar driver" id="driverProgressBar"></div>
                    </div>
                    <div class="chip-info" id="driverChipInfo"></div>
                </div>

                <!-- DISPLAY Panel -->
                <div class="device-panel display">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/>
                        </svg>
                        DISPLAY (Display)
                    </h2>

                    <div class="status">
                        <div class="status-dot" id="displayStatusDot"></div>
                        <span id="displayStatusText">Disconnected</span>
                    </div>

                    <button class="btn-connect" id="displayConnectBtn">
                        Connect DISPLAY
                    </button>
                    <button class="btn-update display-btn" id="displayUpdateBtn" disabled>
                        Update DISPLAY
                    </button>

                    <div class="progress" id="displayProgress">
                        <div class="progress-bar display" id="displayProgressBar"></div>
                    </div>
                    <div class="chip-info" id="displayChipInfo"></div>
                </div>
            </div>

            <!-- Console -->
            <div class="console-section">
                <h2>Console</h2>
                <div id="console"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.7/bundle.js';

        // Configuration
        const FIRMWARE_BASE_URL = 'https://t4k3.github.io/BallgunFlasher';
        const BAUD_RATE = 921600;

        const FLASH_CONFIG = {
            DRIVER: [
                { offset: 0x0, file: 'DRIVER/bootloader.bin' },
                { offset: 0x8000, file: 'DRIVER/partition-table.bin' },
                { offset: 0xe000, file: 'DRIVER/ota_data_initial.bin' },
                { offset: 0x10000, file: 'DRIVER/BallgunDRIVER.bin' }
            ],
            DISPLAY: [
                { offset: 0x0, file: 'DISPLAY/bootloader.bin' },
                { offset: 0x8000, file: 'DISPLAY/partition-table.bin' },
                { offset: 0xe000, file: 'DISPLAY/ota_data_initial.bin' },
                { offset: 0x10000, file: 'DISPLAY/BallgunDISPLAY.bin' }
            ]
        };

        // State for each device
        const devices = {
            driver: { transport: null, esploader: null, connected: false, device: null },
            display: { transport: null, esploader: null, connected: false, device: null }
        };

        const consoleEl = document.getElementById('console');

        // Check WebSerial support
        if (!('serial' in navigator)) {
            document.getElementById('browserWarning').style.display = 'block';
            document.getElementById('driverConnectBtn').disabled = true;
            document.getElementById('displayConnectBtn').disabled = true;
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'driver' ? '[DRIVER] ' : type === 'display' ? '[DISPLAY] ' : '';
            consoleEl.textContent += `[${time}] ${prefix}${msg}\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateStatusText(deviceType, connected) {
            document.getElementById(`${deviceType}StatusText`).textContent = connected ? 'Connected' : 'Disconnected';
        }

        function setProgress(deviceType, percent) {
            const progress = document.getElementById(`${deviceType}Progress`);
            const progressBar = document.getElementById(`${deviceType}ProgressBar`);
            progress.style.display = 'block';
            progressBar.style.width = `${percent}%`;
        }

        function hideProgress(deviceType) {
            document.getElementById(`${deviceType}Progress`).style.display = 'none';
            document.getElementById(`${deviceType}ProgressBar`).style.width = '0%';
        }

        function updateUI(deviceType) {
            const dev = devices[deviceType];
            const statusDot = document.getElementById(`${deviceType}StatusDot`);
            const statusText = document.getElementById(`${deviceType}StatusText`);
            const connectBtn = document.getElementById(`${deviceType}ConnectBtn`);
            const updateBtn = document.getElementById(`${deviceType}UpdateBtn`);

            if (dev.connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                connectBtn.textContent = `Disconnect ${deviceType.toUpperCase()}`;
                connectBtn.classList.add('connected');
                updateBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                connectBtn.textContent = `Connect ${deviceType.toUpperCase()}`;
                connectBtn.classList.remove('connected');
                updateBtn.disabled = true;
                document.getElementById(`${deviceType}ChipInfo`).textContent = '';
            }
        }

        // Terminal object for ESPLoader
        function createTerminal(deviceType) {
            return {
                clean() {},
                writeLine(data) {
                    log(data, deviceType);
                },
                write(data) {
                    if (data && data.trim()) {
                        consoleEl.textContent += data;
                        consoleEl.scrollTop = consoleEl.scrollHeight;
                    }
                }
            };
        }

        async function connect(deviceType) {
            const dev = devices[deviceType];
            try {
                log(`Requesting serial port...`, deviceType);
                dev.device = await navigator.serial.requestPort();

                log(`Connecting...`, deviceType);
                dev.transport = new Transport(dev.device, true);

                const loaderOptions = {
                    transport: dev.transport,
                    baudrate: BAUD_RATE,
                    terminal: createTerminal(deviceType)
                };

                dev.esploader = new ESPLoader(loaderOptions);

                log(`Detecting chip...`, deviceType);
                await dev.esploader.main();

                const chipInfo = document.getElementById(`${deviceType}ChipInfo`);
                chipInfo.textContent = `${dev.esploader.chipName} - MAC: ${await dev.esploader.readMac()}`;

                dev.connected = true;
                updateUI(deviceType);
                log(`Connected successfully!`, deviceType);

            } catch (error) {
                log(`Error: ${error.message}`, deviceType);
                dev.connected = false;
                updateUI(deviceType);
            }
        }

        async function disconnect(deviceType) {
            const dev = devices[deviceType];
            try {
                if (dev.transport) {
                    await dev.transport.disconnect();
                }
                dev.connected = false;
                dev.esploader = null;
                dev.transport = null;
                dev.device = null;
                updateUI(deviceType);
                log(`Disconnected`, deviceType);
            } catch (error) {
                log(`Disconnect error: ${error.message}`, deviceType);
            }
        }

        async function downloadFile(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Download failed: ${url}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            const bytes = new Uint8Array(arrayBuffer);
            let binaryString = '';
            for (let i = 0; i < bytes.length; i++) {
                binaryString += String.fromCharCode(bytes[i]);
            }
            return binaryString;
        }

        async function updateFirmware(deviceType) {
            const dev = devices[deviceType];
            if (!dev.connected || !dev.esploader) {
                log('Not connected!', deviceType);
                return;
            }

            const files = FLASH_CONFIG[deviceType.toUpperCase()];
            const updateBtn = document.getElementById(`${deviceType}UpdateBtn`);
            const connectBtn = document.getElementById(`${deviceType}ConnectBtn`);

            updateBtn.disabled = true;
            connectBtn.disabled = true;

            try {
                // STEP 1: ERASE
                log(`\n========================================`, deviceType);
                log(`  UPDATE ${deviceType.toUpperCase()}`, deviceType);
                log(`========================================\n`, deviceType);

                log('Step 1/2: Erasing flash...', deviceType);
                setProgress(deviceType, 5);

                await dev.esploader.eraseFlash();

                log('Erase complete!\n', deviceType);
                setProgress(deviceType, 15);

                // STEP 2: DOWNLOAD & FLASH
                log('Step 2/2: Downloading firmware...', deviceType);
                const fileArray = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const url = `${FIRMWARE_BASE_URL}/${file.file}`;
                    log(`  ${file.file}...`, deviceType);

                    const data = await downloadFile(url);
                    fileArray.push({
                        address: file.offset,
                        data: data
                    });

                    log(`    OK (${Math.round(data.length / 1024)} KB)`, deviceType);
                    setProgress(deviceType, 15 + (i + 1) / files.length * 15);
                }

                log('\nFlashing...', deviceType);

                const flashOptions = {
                    fileArray: fileArray,
                    flashSize: "keep",
                    flashMode: "keep",
                    flashFreq: "keep",
                    eraseAll: false,
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const fileProgress = written / total;
                        const overallProgress = 30 + ((fileIndex + fileProgress) / fileArray.length * 70);
                        setProgress(deviceType, overallProgress);
                    }
                };

                await dev.esploader.writeFlash(flashOptions);

                setProgress(deviceType, 100);
                log(`\n========================================`, deviceType);
                log(`  ${deviceType.toUpperCase()} UPDATE COMPLETE!`, deviceType);
                log(`========================================\n`, deviceType);

                setTimeout(() => hideProgress(deviceType), 3000);

            } catch (error) {
                log(`\nError: ${error.message}`, deviceType);
                hideProgress(deviceType);
            }

            updateBtn.disabled = false;
            connectBtn.disabled = false;
        }

        // Event listeners - DRIVER
        document.getElementById('driverConnectBtn').addEventListener('click', async () => {
            if (devices.driver.connected) {
                await disconnect('driver');
            } else {
                await connect('driver');
            }
        });
        document.getElementById('driverUpdateBtn').addEventListener('click', () => updateFirmware('driver'));

        // Event listeners - DISPLAY
        document.getElementById('displayConnectBtn').addEventListener('click', async () => {
            if (devices.display.connected) {
                await disconnect('display');
            } else {
                await connect('display');
            }
        });
        document.getElementById('displayUpdateBtn').addEventListener('click', () => updateFirmware('display'));

        // Initial log
        log('Ballgun Web Flasher ready');
        log('Follow the guide on the left to update your Ballgun');
        log('');
    </script>
</body>
</html>
