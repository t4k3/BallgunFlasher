<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ballgun Flasher</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .warning {
            background: #ff6b3520;
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .warning a {
            color: #ff6b35;
        }
        .section {
            background: #252540;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            margin-top: 0;
            color: #00d4ff;
            font-size: 1.1em;
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-connect {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .btn-connect:hover:not(:disabled) {
            background: #00a8cc;
        }
        .btn-connect.connected {
            background: #00c853;
        }
        .btn-flash {
            background: #7c4dff;
            color: white;
        }
        .btn-flash:hover:not(:disabled) {
            background: #651fff;
        }
        .btn-erase {
            background: #ff5252;
            color: white;
        }
        .btn-erase:hover:not(:disabled) {
            background: #ff1744;
        }
        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-group button {
            flex: 1;
        }
        #console {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5252;
        }
        .status-dot.connected {
            background: #00c853;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #0d0d1a;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #7c4dff, #00d4ff);
            width: 0%;
            transition: width 0.3s;
        }
        select {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #eee;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Ballgun Flasher</h1>
    <p class="subtitle">ESP32-C6 Web Programmer</p>

    <div class="warning" id="browserWarning" style="display: none;">
        WebSerial non supportato. Usa <a href="https://www.google.com/chrome/" target="_blank">Google Chrome</a> o Edge.
    </div>

    <div class="section">
        <h2>1. Connessione</h2>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnesso</span>
        </div>
        <button class="btn-connect" id="connectBtn">
            Connetti ESP32
        </button>
    </div>

    <div class="section">
        <h2>2. Seleziona Device</h2>
        <select id="deviceSelect">
            <option value="DRIVER">DRIVER (Motori)</option>
            <option value="DISPLAY">DISPLAY (Schermo)</option>
        </select>
    </div>

    <div class="section">
        <h2>3. Operazioni</h2>
        <div class="btn-group">
            <button class="btn-flash" id="flashBtn" disabled>
                Flash Firmware
            </button>
            <button class="btn-erase" id="eraseBtn" disabled>
                Erase Flash
            </button>
        </div>
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <div class="section">
        <h2>Console</h2>
        <div id="console"></div>
    </div>

    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.7/bundle.js';

        // Configuration
        const FIRMWARE_BASE_URL = 'https://t4k3.github.io/BallgunFlasher';
        const BAUD_RATE = 921600;

        const FLASH_CONFIG = {
            DRIVER: [
                { offset: 0x0, file: 'DRIVER/bootloader.bin' },
                { offset: 0x8000, file: 'DRIVER/partition-table.bin' },
                { offset: 0xe000, file: 'DRIVER/ota_data_initial.bin' },
                { offset: 0x10000, file: 'DRIVER/BallgunDRIVER.bin' }
            ],
            DISPLAY: [
                { offset: 0x0, file: 'DISPLAY/bootloader.bin' },
                { offset: 0x8000, file: 'DISPLAY/partition-table.bin' },
                { offset: 0xe000, file: 'DISPLAY/ota_data_initial.bin' },
                { offset: 0x10000, file: 'DISPLAY/BallgunDISPLAY.bin' }
            ]
        };

        let transport = null;
        let esploader = null;
        let connected = false;
        let device = null;

        const consoleEl = document.getElementById('console');
        const connectBtn = document.getElementById('connectBtn');
        const flashBtn = document.getElementById('flashBtn');
        const eraseBtn = document.getElementById('eraseBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');

        // Check WebSerial support
        if (!('serial' in navigator)) {
            document.getElementById('browserWarning').style.display = 'block';
            connectBtn.disabled = true;
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            consoleEl.textContent += `[${time}] ${msg}\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function setProgress(percent) {
            progress.style.display = 'block';
            progressBar.style.width = `${percent}%`;
        }

        function hideProgress() {
            progress.style.display = 'none';
            progressBar.style.width = '0%';
        }

        function updateUI() {
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connesso';
                connectBtn.textContent = 'Disconnetti';
                connectBtn.classList.add('connected');
                flashBtn.disabled = false;
                eraseBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnesso';
                connectBtn.textContent = 'Connetti ESP32';
                connectBtn.classList.remove('connected');
                flashBtn.disabled = true;
                eraseBtn.disabled = true;
            }
        }

        // Terminal object for ESPLoader
        const espLoaderTerminal = {
            clean() {
                consoleEl.textContent = '';
            },
            writeLine(data) {
                log(data);
            },
            write(data) {
                if (data && data.trim()) {
                    consoleEl.textContent += data;
                    consoleEl.scrollTop = consoleEl.scrollHeight;
                }
            }
        };

        async function connect() {
            try {
                log('Richiesta porta seriale...');
                device = await navigator.serial.requestPort();

                log('Connessione in corso...');
                transport = new Transport(device, true);

                const loaderOptions = {
                    transport: transport,
                    baudrate: BAUD_RATE,
                    terminal: espLoaderTerminal
                };

                esploader = new ESPLoader(loaderOptions);

                log('Detecting chip...');
                await esploader.main();

                log(`Chip: ${esploader.chipName}`);

                connected = true;
                updateUI();
                log('Connesso con successo!');

            } catch (error) {
                log(`Errore: ${error.message}`);
                connected = false;
                updateUI();
            }
        }

        async function disconnect() {
            try {
                if (transport) {
                    await transport.disconnect();
                }
                connected = false;
                esploader = null;
                transport = null;
                device = null;
                updateUI();
                log('Disconnesso');
            } catch (error) {
                log(`Errore disconnessione: ${error.message}`);
            }
        }

        async function downloadFile(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Download fallito: ${url}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            // Convert to binary string for esptool-js
            const bytes = new Uint8Array(arrayBuffer);
            let binaryString = '';
            for (let i = 0; i < bytes.length; i++) {
                binaryString += String.fromCharCode(bytes[i]);
            }
            return binaryString;
        }

        async function flashFirmware() {
            if (!connected || !esploader) {
                log('Non connesso!');
                return;
            }

            const deviceType = document.getElementById('deviceSelect').value;
            const files = FLASH_CONFIG[deviceType];

            flashBtn.disabled = true;
            eraseBtn.disabled = true;

            try {
                log(`\n========================================`);
                log(`  FLASH ${deviceType}`);
                log(`========================================\n`);

                // Download all files
                log('Download firmware...');
                const fileArray = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const url = `${FIRMWARE_BASE_URL}/${file.file}`;
                    log(`  ${file.file}...`);

                    const data = await downloadFile(url);
                    fileArray.push({
                        address: file.offset,
                        data: data
                    });

                    log(`    OK (${Math.round(data.length / 1024)} KB)`);
                    setProgress((i + 1) / files.length * 30);
                }

                log('\nFlashing...');

                const flashOptions = {
                    fileArray: fileArray,
                    flashSize: "keep",
                    flashMode: "keep",
                    flashFreq: "keep",
                    eraseAll: false,
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const fileProgress = written / total;
                        const overallProgress = 30 + ((fileIndex + fileProgress) / fileArray.length * 70);
                        setProgress(overallProgress);
                    }
                };

                await esploader.writeFlash(flashOptions);

                setProgress(100);
                log(`\n${deviceType} FLASH COMPLETATO!`);

                setTimeout(hideProgress, 2000);

            } catch (error) {
                log(`\nErrore: ${error.message}`);
                hideProgress();
            }

            flashBtn.disabled = false;
            eraseBtn.disabled = false;
        }

        async function eraseFirmware() {
            if (!connected || !esploader) {
                log('Non connesso!');
                return;
            }

            flashBtn.disabled = true;
            eraseBtn.disabled = true;

            try {
                log(`\n========================================`);
                log(`  ERASE FLASH`);
                log(`========================================\n`);

                log('Cancellazione in corso...');
                setProgress(50);

                await esploader.eraseFlash();

                setProgress(100);
                log('ERASE COMPLETATO!');

                setTimeout(hideProgress, 2000);

            } catch (error) {
                log(`\nErrore: ${error.message}`);
                hideProgress();
            }

            flashBtn.disabled = false;
            eraseBtn.disabled = false;
        }

        // Event listeners
        connectBtn.addEventListener('click', async () => {
            if (connected) {
                await disconnect();
            } else {
                await connect();
            }
        });

        flashBtn.addEventListener('click', flashFirmware);
        eraseBtn.addEventListener('click', eraseFirmware);

        // Initial log
        log('Ballgun Web Flasher pronto');
        log('Usa Chrome o Edge (Safari non supportato)');
        log('');
    </script>
</body>
</html>
